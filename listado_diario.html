<!DOCTYPE html>
<html>
<head>
    <title>Listado de Pasajeros</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .guest-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .guest-list th, .guest-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .guest-list th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .guest-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .guest-list tr:hover {
            background-color: #f5f5f5;
        }
        .media-pension {
            background-color: #e8f5e9;
        }
        .controls {
            margin: 20px 0;
        }
        .print-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .print-button:hover {
            background-color: #45a049;
        }
        @media print {
            .controls {
                display: none;
            }
            .guest-list {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Listado de Pasajeros</h1>
        <div id="currentDate"></div>
    </div>
    <div class="controls">
        <button class="print-button" onclick="window.print()">Imprimir Listado</button>
    </div>
    <div id="guestListContainer"></div>

    <script>
    function parseCSVLine(line) {
        const result = [];
        let cur = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    cur += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === ',' && !inQuotes) {
                result.push(cur);
                cur = '';
            } else {
                cur += ch;
            }
        }
        result.push(cur);
        return result.map(s => s.trim());
    }

    function parseDateDDMMYYYY(str) {
        if (!str) return null;
        const parts = str.split('/');
        if (parts.length !== 3) return null;
        const d = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const y = parseInt(parts[2], 10);
        if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
        return new Date(y, m, d);
    }

    function processGuestList(fileContents) {
        const lines = fileContents.split(/\r?\n/);
        const guests = [];
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        for (let i = 1; i < lines.length; i++) {
            const raw = lines[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;

            const fields = parseCSVLine(line);
            if (fields.length < 10) continue;

            const checkIn = parseDateDDMMYYYY(fields[8]);
            const checkOut = parseDateDDMMYYYY(fields[9]);
            if (!checkIn || !checkOut) continue;

            checkIn.setHours(0, 0, 0, 0);
            checkOut.setHours(0, 0, 0, 0);

            if (checkIn <= today && today <= checkOut) {
                const servicios = fields[16] || '';
                guests.push({
                    habitacion: (fields[2] || '').trim(),
                    apellido: (fields[14] || '').trim(),
                    nombre: (fields[13] || '').trim(),
                    dni: (fields[12] || '').trim(),
                    checkIn: fields[8],
                    checkOut: fields[9],
                    servicios: servicios,
                    plazas: (fields[5] || '').trim(),
                    voucher: (fields[6] || '').trim()
                });
            }
        }

        guests.sort((a, b) => {
            const na = a.habitacion || '';
            const nb = b.habitacion || '';
            const ai = parseInt(na, 10);
            const bi = parseInt(nb, 10);
            if (!isNaN(ai) && !isNaN(bi)) return ai - bi;
            return na.localeCompare(nb);
        });

        return guests;
    }

    function displayGuestList(guests) {
        const container = document.getElementById('guestListContainer');
        if (!container) return;
        let html = '<table class="guest-list">';
        html += `
            <tr>
                <th>Hab.</th>
                <th>Apellido y Nombre</th>
                <th>DNI</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Servicios</th>
                <th>Plazas</th>
                <th>Voucher</th>
            </tr>
        `;

        guests.forEach(guest => {
            const serviciosUpper = (guest.servicios || '').toUpperCase();
            const hasMediaPension = serviciosUpper.includes('MEDIA PENSION');
            html += `
                <tr class="${hasMediaPension ? 'media-pension' : ''}">
                    <td>${escapeHtml(guest.habitacion)}</td>
                    <td>${escapeHtml(guest.apellido)}, ${escapeHtml(guest.nombre)}</td>
                    <td>${escapeHtml(guest.dni)}</td>
                    <td>${escapeHtml(guest.checkIn)}</td>
                    <td>${escapeHtml(guest.checkOut)}</td>
                    <td>${escapeHtml(guest.servicios)}</td>
                    <td>${escapeHtml(guest.plazas)}</td>
                    <td>${escapeHtml(guest.voucher)}</td>
                </tr>
            `;
        });

        html += '</table>';
        container.innerHTML = html;

        const dateElem = document.getElementById('currentDate');
        if (dateElem) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElem.textContent = new Date().toLocaleDateString('es-AR', options);
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, function (s) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return map[s];
        });
    }

    function handleFileSelect() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.csv';

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const guests = processGuestList(e.target.result || '');
                    displayGuestList(guests);
                } catch (err) {
                    console.error('Error procesando CSV:', err);
                    alert('Ocurrió un error procesando el archivo CSV. Revisa la consola para más detalles.');
                }
            };
            reader.readAsText(file);
        });

        fileInput.click();
    }

    window.onload = handleFileSelect;
</script>

</body>
</html>